# Implementation Plan

- [x] 1. サーバ基盤と設定管理の確立
- [x] 1.1 環境既定値と stdio 起動の実装
  - 既定の環境値を解決し、未設定時に安全なデフォルトを適用する
  - stdio トランスポートでリクエストを受け付け、ツールを登録する
  - _Requirements: 5.1, 5.4_

- [x] 1.2 設定検証と起動前チェック
  - ドキュメントルートの存在と `classes` 配下の妥当性を検証する
  - Node ランタイムのバージョンを検査し、基準未満は起動を拒否する
  - _Requirements: 5.2, 5.3_

- [x] 1.3 ログ出力レベルと起動ログ
  - ログレベルを `silent|error|warn|info|debug` で切り替え可能にする
  - 起動時に主要設定とインデックス統計の要約を記録する
  - _Requirements: 9.1, 9.2_

- [x] 2. XML 解析と正規化
- [x] 2.1 Godot 4.x/3.x スキーマ対応のパース実装
  - 4.x の全セクションを抽出し、3.x の欠落は空配列で補う
  - クラス単位で型整合の取れた内部表現へ変換する
  - _Requirements: 1.1, 1.2, 1.3_

- [x] 2.2 CDATA と実体参照の処理
  - 文字参照を正しく展開し、コード片やインライン書式を保持する
  - _Requirements: 1.4, 8.4_

- [x] 2.3 欠落セクションの正規化と一貫性
  - 欠落セクションを空配列として扱い、取得 API の応答で一貫性を保つ
  - _Requirements: 1.3, 3.1_

- [x] 2.4 解析失敗時の詳細エラー
  - ファイル名と可能なら行・列情報を含む診断を返す
  - _Requirements: 6.1_

- [x] 3. インデックス構築と永続化
- [x] 3.1 倒置インデックスとスコアリング
  - トークナイズと tf-idf/BM25 風のスコアリングを実装し、クラス名完全一致を強ブーストする
  - _Requirements: 1.6, 2.3_

- [x] 3.2 ウォームスタートの保存と読み込み
  - メモリ内インデックスを JSON に保存し、起動時に存在すれば読み込む
  - _Requirements: 4.1, 4.2_

- [x] 3.3 再構築と原子的置換
  - 読み込み失敗やドキュメント更新を検知してバックグラウンド再構築し、原子的に切り替える
  - _Requirements: 4.3, 4.4_

- [x] 3.4 性能計測と目標達成の検証
  - コールドスタート時間、検索 p95、メモリ使用量を計測し、目標を満たすまで改善する
  - _Requirements: 7.1, 7.2, 7.3, 7.4_

- [x] 4. 検索ツールの実装（godot.search）
- [x] 4.1 クエリ処理と結果整形
  - クエリ正規化とトークナイズを行い、スコア降順で `name`、`kind`、`score` を含む結果を返す
  - `limit` による件数制限を適用する
  - _Requirements: 2.1, 2.5_

- [x] 4.2 種別フィルタリング
  - 種別指定時に対象を `class|method|property|signal|constant` のみに限定する
  - _Requirements: 2.2_

- [x] 4.3 スニペット生成と強調
  - `brief` または `description` から短い抜粋を生成し、一致語を強調する
  - _Requirements: 2.4_

- [x] 4.4 未ヒット時の空配列
  - 該当がない場合は空配列を返し、エラーにしない
  - _Requirements: 2.6_

- [x] 5. 取得ツールの実装（godot.get_class, godot.get_symbol, godot.list_classes）
- [x] 5.1 クラス取得の応答一貫性
  - 欠落セクションを空配列として返しつつ、クラス情報を提供する
  - _Requirements: 3.1_

- [x] 5.2 シンボル解決の実装
  - `Class.member` 形式を解析し、種別に応じた詳細情報を返す
  - _Requirements: 3.3_

- [x] 5.3 不在時の候補提示
  - 見つからない場合に最大5件の近似候補を提示し、`NOT_FOUND` を返す
  - _Requirements: 3.2, 3.4, 6.3_

- [x] 5.4 不正形式の検出
  - 形式誤りを検出して `INVALID_ARGUMENT` を返し、正しい形式例を示す
  - _Requirements: 3.5, 6.2_

- [x] 5.5 クラス一覧の提供
  - 前方一致でクラス名を列挙し、上限件数を適用する
  - _Requirements: 3.6_

- [x] 6. URI 生成の一貫性
- [x] 6.1 クラスとシンボルの URI 付与
  - 結果に `godot://class/ClassName` および `godot://symbol/ClassName/kind/name` を付与する
  - _Requirements: 10.1_

- [x] 6.2 検索 URI の生成
  - クエリを保持する `godot://search?q=...&kind=...` を生成する
  - _Requirements: 10.2_

- [x] 7. セキュリティとアクセス制御
- [x] 7.1 ディレクトリ境界の強制
  - 読み取りをドキュメントルート内に、書き込みをインデックス保存先に限定する
  - _Requirements: 8.2, 8.3_

- [x] 7.2 ネットワーク無効化の保証
  - 実行中に外部ネットワークを使用しないことを検証し、テストで担保する
  - _Requirements: 8.1, 1.5_

- [x] 7.3 コード片の非実行保証
  - ドキュメントのコード例を常にテキストとして扱う
  - _Requirements: 8.4_

- [x] 8. エラーハンドリングと診断
- [x] 8.1 入力検証の統一
  - 必須パラメータ欠落や形式誤りを一律に検出し、`INVALID_ARGUMENT` を返す
  - _Requirements: 6.2_

- [x] 8.2 例外の正規化と相関
  - 予期しない例外を `INTERNAL` に正規化し、相関識別子でログと結び付ける
  - _Requirements: 6.4_

- [x] 8.3 デバッグログの充実
  - トークン化されたクエリと上位スコアをデバッグレベルで記録し、機微な本文は記録しない
  - _Requirements: 9.3, 9.4_
